{% extends "pc/base.html" %}
{% load static %}
{% load compile_static %}
{% load custom_filters %}

{% block css %}
    <link rel="stylesheet" href="{% static 'less/pc/chat.less'|compile %}">
{% endblock %}

{% block js %}
    <script src="{% static "channels/js/websocketbridge.js" %}" type="text/javascript"></script>
    <script>
        var ws_path = '{{ chat_host }}/?session_key={{ request.session.session_key }}';
        var make_path = '{% url "make_room" %}';
        var active = '{{ active }}';
        var my_id = {{ request.user.id }};
    </script>
    <script src="{% static 'js/chat.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="all_wrapper">
    <div class="title">메신저</div>
    <div class="subtitle">가이드 또는 여행자와 대화를 나눠주세요.</div>
        <form id="chat_join_form">
            {% csrf_token %}
            <input type="text" name="opponent">
            <button type="button" onclick="make_room()">MAKE</button>
        </form>
        <div class="chat_list">
            {% for room in rooms %}
                <div class="room-link {% if room.user_1_id == active or room.user_2_id == active %}active{% endif %}"
                     onclick="join_room(this, {{ room.id }})">
                <div class="profile">
                    <img src="{% if room.opponent.profile.photo %}{{ room.opponent.profile.photo.url }}
                                {% else %}{% static 'image/icon/profile_empty.png' %}{% endif %}"
                         alt="profile"></div>
                <div class="name">{{ room.opponent.profile.full_name }}</div>
                <div class="timestamp">
                    {% if room.timestamp|is_today %}
                    {{ room.timestamp|date:"H:i:s" }}
                    {% else %}
                    {{ room.timestamp|date:"Y/m/d" }}
                    {% endif %}
                </div>
                </div>
            {% empty %}
                <p class="empty">아직 채팅이 없습니다. <br>
                    원하는 상대방과 대화를 나눠보세요</p>
            {% endfor %}
        </div><!--
    --><div id="chats">
    </div>
    </div>
{% endblock %}
